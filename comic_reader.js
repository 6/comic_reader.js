// Generated by CoffeeScript 1.5.0
(function() {
  var ComicMetaView, ComicReaderRouter, ComicReaderView, Page, Pages,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  Page = (function(_super) {

    __extends(Page, _super);

    function Page() {
      this.onImageLoad = __bind(this.onImageLoad, this);
      this.fetch = __bind(this.fetch, this);
      Page.__super__.constructor.apply(this, arguments);
    }

    Page.prototype.fetch = function() {
      var preloader;
      preloader = new ImagePreloader({
        urls: [this.get('url')],
        complete: this.onImageLoad
      });
      return preloader.start();
    };

    Page.prototype.onImageLoad = function() {
      return this.set('fetched', true);
    };

    return Page;

  })(Backbone.Model);

  Pages = (function(_super) {

    __extends(Pages, _super);

    function Pages() {
      this.setCurrentPage = __bind(this.setCurrentPage, this);
      this.percentFetched = __bind(this.percentFetched, this);
      this.fetched = __bind(this.fetched, this);
      this.fetch = __bind(this.fetch, this);
      this.initialize = __bind(this.initialize, this);
      Pages.__super__.constructor.apply(this, arguments);
    }

    Pages.prototype.model = Page;

    Pages.prototype.initialize = function() {
      return this.currentPageIndex = 0;
    };

    Pages.prototype.fetch = function() {
      var _this = this;
      return _.map(this.models, function(model) {
        return model.fetch();
      });
    };

    Pages.prototype.fetched = function() {
      var _this = this;
      return _.filter(this.models, function(model) {
        return model.get('fetched');
      });
    };

    Pages.prototype.percentFetched = function() {
      return Math.round(this.fetched().length / this.size() * 100);
    };

    Pages.prototype.setCurrentPage = function(pageIndex) {
      if (!(pageIndex >= 0 && pageIndex < this.models.length)) {
        return;
      }
      this.currentPageIndex = pageIndex;
      return this.trigger('change:page', pageIndex);
    };

    return Pages;

  })(Backbone.Collection);

  ComicMetaView = (function(_super) {

    __extends(ComicMetaView, _super);

    function ComicMetaView() {
      this.render = __bind(this.render, this);
      this.initialize = __bind(this.initialize, this);
      ComicMetaView.__super__.constructor.apply(this, arguments);
    }

    ComicMetaView.prototype.initialize = function(options) {
      if (options == null) {
        options = {};
      }
      this.pages = options.pages;
      this.pages.on('change:fetched', this.render);
      return this.pages.on('change:page', this.render);
    };

    ComicMetaView.prototype.render = function() {
      return this.$el.html("<div class='progress'>\n  <div class='progress-inner' style='width:" + (this.pages.percentFetched()) + "%'></div>\n</div>\n<nav>\n  <div class='page-index'>" + (this.pages.currentPageIndex + 1) + " of " + this.pages.length + "</div>\n</nav>");
    };

    return ComicMetaView;

  })(Backbone.View);

  ComicReaderView = (function(_super) {

    __extends(ComicReaderView, _super);

    function ComicReaderView() {
      this.showPage = __bind(this.showPage, this);
      this.render = __bind(this.render, this);
      this.initialize = __bind(this.initialize, this);
      ComicReaderView.__super__.constructor.apply(this, arguments);
    }

    ComicReaderView.prototype.initialize = function(options) {
      if (options == null) {
        options = {};
      }
      this.pages = options.pages;
      this.pages.on('change:page', this.showPage);
      this.render();
      return this.metaView = new ComicMetaView({
        el: ".comic-meta-wrap",
        pages: this.pages
      });
    };

    ComicReaderView.prototype.render = function() {
      return this.$el.html("<div class='comic-meta-wrap'></div>\n<div class='comic-image-wrap'></div>");
    };

    ComicReaderView.prototype.showPage = function(pageIndex) {
      var page;
      page = this.pages.at(pageIndex);
      this.$el.find(".comic-image-wrap").hide(0).html("<a href=\"#p" + (pageIndex + 2) + "\">\n  <img class='comic-image' src='" + (page.get('url')) + "'>\n</a>").fadeIn(50);
      return $(document).scrollTop(0);
    };

    return ComicReaderView;

  })(Backbone.View);

  ComicReaderRouter = (function(_super) {

    __extends(ComicReaderRouter, _super);

    function ComicReaderRouter() {
      this["default"] = __bind(this["default"], this);
      this.read = __bind(this.read, this);
      this.initialize = __bind(this.initialize, this);
      ComicReaderRouter.__super__.constructor.apply(this, arguments);
    }

    ComicReaderRouter.prototype.routes = {
      "p:page": "read",
      "*path": "default"
    };

    ComicReaderRouter.prototype.initialize = function(options) {
      if (options == null) {
        options = {};
      }
      return this.pages = options.pages, options;
    };

    ComicReaderRouter.prototype.read = function(page) {
      return this.pages.setCurrentPage(parseInt(page) - 1);
    };

    ComicReaderRouter.prototype["default"] = function(path) {
      return this.pages.setCurrentPage(0);
    };

    return ComicReaderRouter;

  })(Backbone.Router);

  this.ComicReader = (function() {

    function ComicReader(options) {
      var pages, router, view,
        _this = this;
      if (options == null) {
        options = {};
      }
      pages = new Pages(_.map(options.urls || [], function(url) {
        return {
          url: url,
          fetched: false
        };
      }));
      options.pages = pages;
      view = new ComicReaderView(options);
      router = new ComicReaderRouter({
        pages: pages
      });
      Backbone.history.start({
        pushState: false
      });
      pages.fetch();
      $(document).on("keyup", function(e) {
        var pageDelta, _ref;
        if ((_ref = e.keyCode) !== 37 && _ref !== 39) {
          return;
        }
        if (e.keyCode === 37) {
          pageDelta = -1;
        } else if (e.keyCode === 39) {
          pageDelta = 1;
        }
        return window.location.hash = "p" + (pages.currentPageIndex + pageDelta + 1);
      });
    }

    return ComicReader;

  })();

}).call(this);
